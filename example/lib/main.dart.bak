import 'package:flutter/material.dart';
import 'package:custom_paint_diagram_layer/custom_paint_diagram_layer.dart';
import 'package:custom_paint_diagram_layer/mixins/element_boundary_positioning_mixin.dart';

void main() {
  runApp(const MaterialApp(home: GroupElementDemo()));
}

class GroupElementDemo extends StatefulWidget {
  const GroupElementDemo({super.key});

  @override
  State<GroupElementDemo> createState() => _GroupElementDemoState();
}

class _GroupElementDemoState extends State<GroupElementDemo> with ElementBoundaryPositioningMixin {
  late IDiagramLayer _diagramLayer;
  double _groupY = 0.0;
  double _sliderValue = 0.0;
  late GroupElement _group;

  // Constants for coordinate system
  static const double coordRange = 10.0;
  static const double margin = 1.0;

  @override
  void initState() {
    super.initState();
    _initDiagramLayer();
  }

  void _initDiagramLayer() {
    _createDiagramLayer(_groupY);
  }

  void _createDiagramLayer(double yPosition) {
    // Create a group with overlapping elements
    _group = GroupElement(
      x: 0,
      y: yPosition,
      children: [
        // A semi-transparent blue rectangle
        RectangleElement(
          x: -1,
          y: -1,
          width: 2,
          height: 2,
          color: Colors.blue,
          fillColor: Colors.blue.withOpacity(0.3),
        ),
        // An overlapping semi-transparent red circle
        CircleElement(
          x: 0,
          y: 0,
          radius: 1,
          color: Colors.red,
          fillColor: Colors.red.withOpacity(0.3),
        ),
      ],
    );

    // Initialize the diagram layer with coordinate axes and the group
    _diagramLayer = BasicDiagramLayer(
      coordinateSystem: const CoordinateSystem(
        origin: Offset.zero,  // Will be set by CanvasAlignment
        xRangeMin: -coordRange,
        xRangeMax: coordRange,
        yRangeMin: -coordRange,
        yRangeMax: coordRange,
        scale: 1.0,  // Will be adjusted by CanvasAlignment
      ),
      showAxes: false,  // We'll toggle axes on after adding elements
    )
      .addElement(GridElement(
        x: 0,
        y: 0,
        majorSpacing: 1.0,
        minorSpacing: 0.2,
        majorColor: Colors.grey.withOpacity(0.5),
        minorColor: Colors.grey.withOpacity(0.2),
      ))
      .addElement(_group)
      .toggleAxes();  // Add axes last as per Implementation Guide
  }

  void _updateGroupPosition(double newSliderValue) {
    // Calculate new position using the mixin
    final position = calculateBoundedPosition(
      element: _group,
      sliderValue: newSliderValue,
      coordinateSystem: _diagramLayer.coordinateSystem,
      margin: margin,
      elementHeight: 4.0, // Total height of the group (2 units above and below center)
    );

    setState(() {
      _sliderValue = newSliderValue;
      _groupY = position;
      _createDiagramLayer(position);
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Overlapping Group Elements Demo'),
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            Expanded(
              child: Center(
                child: Container(
                  width: 600,
                  height: 600,
                  decoration: BoxDecoration(
                    border: Border.all(color: Colors.grey),
                  ),
                  child: CustomPaint(
                    painter: CustomPaintRenderer(_diagramLayer),
                    size: const Size(600, 600),
                  ),
                ),
              ),
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                const Text('Move Group:'),
                Expanded(
                  child: Slider(
                    min: -coordRange,
                    max: coordRange,
                    value: _sliderValue,
                    onChanged: _updateGroupPosition,
                    label: _sliderValue.toStringAsFixed(1),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
